--- 
title: 中级前端进阶--事件循环
author: Sieunyue
date: 2023-07-31
description: 在 JavaScript 中，事件循环（Event Loop）是实现异步编程的核心机制。JavaScript 是单线程的编程语言，意味着它在任何给定时刻只能执行一个任务。然而，通过事件循环，JavaScript 能够实现异步编程，同时处理多个任务，使得代码在等待某些异步操作完成时，不会阻塞主线程的执行
tags: 
- Javascript
--- 

# 中级前端进阶--事件循环
在 JavaScript 中，事件循环（`Event Loop`）是实现异步编程的核心机制。JavaScript 是单线程的编程语言，意味着它在任何给定时刻只能执行一个任务。然而，通过事件循环，JavaScript 能够实现异步编程，同时处理多个任务，使得代码在等待某些异步操作完成时，不会阻塞主线程的执行。


## 定义
[用户代理](https://tc39.es/ecma262/#sec-agents)使用事件循环来处理事件、用户交互、脚本、呈现、网络等，每个代理都有一个唯一关联的事件循环。
事件循环具有一个或多个任务队列（task queue），任务队列是一组任务，事件循环开始迭代的时候都会执行队列中的每个任务。
> * 代理由一组执行上下文、一个执行上下文堆栈、一个运行执行上下文、一个代理记录和一个执行线程组成。除了执行线程之外，代理的组成部分仅属于该代理。
> * 任务队列是**集合**，而不是队列，因为事件循环处理模型从所选队列中获取第一个可运行的任务，而不是将第一个任务出列。
> * 微任务队列不是任务队列.

## 任务
一个任务就是由执行诸如从头执行一段程序、执行一个事件回调或一个 interval/timeout 被触发之类的标准机制而被调度的任意 JavaScript 代码。这些都在任务队列上被调度。

在以下时机，任务会被添加到任务队列：

  * 一段新程序或子程序被直接执行时（比如从一个控制台，或在一个 `<script> `元素中运行代码）。
  * 触发了一个事件，将其回调函数添加到任务队列时。
  * 执行到一个由 `setTimeout()` 或 `setInterval()` 创建的 `timeout` 或 `interval`，相应的回调函数被添加到任务队列时。

事件循环会按照这些任务排队的顺序，一个接一个地处理它们。在当前循环中，只有那些当事件循环过程开始时**已经处于任务队列中**的任务会被执行。在每次循环开始之后加入到队列中的任务需要在**下一次循环开始之后**才会被执行。

这个怎么理解呢，就是说如果在一个任务执行的过程中新添加了一个任务，这个新任务并不会在这次的循环中执行，当这次循环结束后的下一个循环才会开始执行。
也可以理解为一次事件循环的迭代开始时，会创建一个当前任务队列的副本，按副本的任务一个接一个执行，新添加的任务并不在这个任务队列的副本中。

## 微任务
微任务指的是通过队列微任务算法创建的任务，微任务队列包含了一类特殊的异步任务，例如`Promise`回调、`async/await`等。当这些任务产生结果时，它们会被添加到微任务队列中。

每次当一个任务退出且执行上下文栈为空的时候，微任务队列中的每一个微任务会依次被执行。
和任务队列不同的是，在微任务执行过程中添加微任务，新的微任务也会在**当前事件循环迭代结束之前**，也就是下一个任务开始前执行，直到清空了微任务队列为止。

> 因为微任务自身可以入列更多的微任务，且事件循环会持续处理微任务直至队列为空，就会存在阻塞渲染线程的风险。
>

## 任务调度
事件循环是如何调度两种任务队列的呢。
当调用堆栈为空时，执行以下步骤：
1. 运行任务队列中第一个可运行的任务，并删除它
2. 运行微任务队列中的所有可用任务，然后将其删除
3. 运行任务队列的下一个任务（跳步骤1）

![示例图](https://food-1256333492.cos.ap-guangzhou.myqcloud.com/assets/efc2b6f9e7afb49ca960f3b9b86420df_1690788452160.png)

## 总结
* 每次循环从任务队列中取出第一个任务执行，而其他线程只需要在合适的时候将任务加入到队列的末尾即可

* 每次当一个任务退出且执行上下文栈为空的时候，微任务队列中的每一个微任务会依次被执行





## 参考
* [agents](https://tc39.es/ecma262/#sec-agents)
* [Event loops](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)
* [微任务与 Javascript 运行时环境](https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth)
